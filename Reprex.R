###FIRST TIME ONLY:
{
  install.packages("readxl")
  install.packages("mixtools")
  install.packages("ggpmisc")
  install.packages("ggplot2")
  install.packages("splus2R")
  install.packages("slider")
  install.packages("openxlsx")
  install.packages("data.table")
  install.packages("zoo")
  install.packages("pracma")
  install.packages("flextable")
  install.packages("officer")
  install.packages("webshot")
  install.packages("dplyr")
  install.packages("magick")
  install.packages("tidyverse")
  install.packages("styler")
}
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'readxl' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'readxl'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\readxl\libs\x64\readxl.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\readxl\libs\x64\readxl.dll: Permission
#> denied
#> Warning: restored 'readxl'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'mixtools' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'mixtools'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\mixtools\libs\x64\mixtools.dll
#> to C:\Users\Owner\Documents\R\win-library\4.1\mixtools\libs\x64\mixtools.dll:
#> Permission denied
#> Warning: restored 'mixtools'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'ggpmisc' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'ggplot2' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'splus2R' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'splus2R'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\splus2R\libs\x64\splus2R.dll
#> to C:\Users\Owner\Documents\R\win-library\4.1\splus2R\libs\x64\splus2R.dll:
#> Permission denied
#> Warning: restored 'splus2R'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'slider' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'slider'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\slider\libs\x64\slider.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\slider\libs\x64\slider.dll: Permission
#> denied
#> Warning: restored 'slider'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'openxlsx' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'openxlsx'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\openxlsx\libs\x64\openxlsx.dll
#> to C:\Users\Owner\Documents\R\win-library\4.1\openxlsx\libs\x64\openxlsx.dll:
#> Permission denied
#> Warning: restored 'openxlsx'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'data.table' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'data.table'
#> Warning in file.copy(savedcopy, lib, recursive =
#> TRUE): problem copying C:\Users\Owner\Documents\R\win-
#> library\4.1\00LOCK\data.table\libs\x64\datatable.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\data.table\libs\x64\datatable.dll:
#> Permission denied
#> Warning: restored 'data.table'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'zoo' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'zoo'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\zoo\libs\x64\zoo.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\zoo\libs\x64\zoo.dll: Permission denied
#> Warning: restored 'zoo'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'pracma' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'flextable' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'officer' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'webshot' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'dplyr' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'dplyr'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\dplyr\libs\x64\dplyr.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\dplyr\libs\x64\dplyr.dll: Permission
#> denied
#> Warning: restored 'dplyr'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'magick' successfully unpacked and MD5 sums checked
#> Warning: cannot remove prior installation of package 'magick'
#> Warning in file.copy(savedcopy, lib, recursive = TRUE): problem copying C:
#> \Users\Owner\Documents\R\win-library\4.1\00LOCK\magick\libs\x64\magick.dll to C:
#> \Users\Owner\Documents\R\win-library\4.1\magick\libs\x64\magick.dll: Permission
#> denied
#> Warning: restored 'magick'
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'tidyverse' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
#> Installing package into 'C:/Users/Owner/Documents/R/win-library/4.1'
#> (as 'lib' is unspecified)
#> package 'styler' successfully unpacked and MD5 sums checked
#> 
#> The downloaded binary packages are in
#>  C:\Users\Owner\AppData\Local\Temp\Rtmpug3zBv\downloaded_packages
###FIRST TIME ONLY ^^^


{
  library(readxl)
  library(mixtools)
  library(ggpmisc)
  library(ggplot2)
  library(splus2R)
  library(slider)
  library(openxlsx)
  library(data.table)
  library(zoo)
  library(pracma)
  library(flextable)
  library(officer)
  library(webshot)
  library(dplyr)
  library(magick)
  library(reprex)
  library(styler)
}
#> Warning: package 'readxl' was built under R version 4.1.3
#> Warning: package 'mixtools' was built under R version 4.1.3
#> mixtools package, version 1.2.0, Released 2020-02-05
#> This package is based upon work supported by the National Science Foundation under Grant No. SES-0518772.
#> Warning: package 'ggpmisc' was built under R version 4.1.3
#> Loading required package: ggpp
#> Warning: package 'ggpp' was built under R version 4.1.3
#> Loading required package: ggplot2
#> Warning: package 'ggplot2' was built under R version 4.1.3
#> 
#> Attaching package: 'ggpp'
#> The following object is masked from 'package:ggplot2':
#> 
#>     annotate
#> Warning in .recacheSubclasses(def@className, def, env): undefined subclass
#> "packedMatrix" of class "replValueSp"; definition not updated
#> Warning in .recacheSubclasses(def@className, def, env): undefined subclass
#> "packedMatrix" of class "mMatrix"; definition not updated
#> Warning: package 'splus2R' was built under R version 4.1.1
#> 
#> Attaching package: 'splus2R'
#> The following object is masked from 'package:mixtools':
#> 
#>     rmvnorm
#> Warning: package 'slider' was built under R version 4.1.3
#> Warning: package 'openxlsx' was built under R version 4.1.3
#> Warning: package 'data.table' was built under R version 4.1.3
#> Warning: package 'zoo' was built under R version 4.1.3
#> 
#> Attaching package: 'zoo'
#> The following objects are masked from 'package:base':
#> 
#>     as.Date, as.Date.numeric
#> Warning: package 'pracma' was built under R version 4.1.3
#> 
#> Attaching package: 'pracma'
#> The following object is masked from 'package:splus2R':
#> 
#>     peaks
#> Warning: package 'flextable' was built under R version 4.1.3
#> Warning: package 'officer' was built under R version 4.1.3
#> 
#> Attaching package: 'officer'
#> The following object is masked from 'package:readxl':
#> 
#>     read_xlsx
#> Warning: package 'webshot' was built under R version 4.1.3
#> Warning: package 'dplyr' was built under R version 4.1.3
#> 
#> Attaching package: 'dplyr'
#> The following objects are masked from 'package:data.table':
#> 
#>     between, first, last
#> The following objects are masked from 'package:stats':
#> 
#>     filter, lag
#> The following objects are masked from 'package:base':
#> 
#>     intersect, setdiff, setequal, union
#> Warning: package 'magick' was built under R version 4.1.3
#> Linking to ImageMagick 6.9.12.3
#> Enabled features: cairo, freetype, fftw, ghostscript, heic, lcms, pango, raw, rsvg, webp
#> Disabled features: fontconfig, x11
#> Warning: package 'reprex' was built under R version 4.1.3
#> Warning: package 'styler' was built under R version 4.1.3

setwd("C:/Users/Owner/OneDrive/UMB/Deredge Lab/Deconvolution/R")

data <- read_excel("peptide 59 to 84.xlsx")

charge=5



#Initial Perimeters
{charge_shift = 1/charge
layout(mat = matrix(c(1, 2, 3, 4, 4, 4, 5, 6, 7, 8, 8, 8, 9, 10, 11, 12, 12, 12),
                    ncol=3, 
                    byrow=TRUE),
       heights = c(10,2, 10, 2,10,4),
       widths = c(10,10,10)
)
par(mar=c(1,1,1,1))
layout.show(n=12)
}


###10 SEC
{x <- na.omit(data$`10 sec`)
  y <- na.omit(data$`10 sec y`)
  df <- data.frame(x,y)
}
{
  y.sg4 <- savgol(y, 3, forder = 4, dorder = 0)
  
  df_smooth <- data.frame(x, y.sg4)
  
  localMaxima <- function(x) {
    # Use -Inf instead if x is numeric (non-integer)
    y <- diff(c(-.Machine$integer.max, x)) > 0L
    rle(y)$lengths
    y <- cumsum(rle(y)$lengths)
    y <- y[seq.int(1L, length(y), 2L)]
    if (x[[1]] == x[[2]]) {
      y <- y[-1]
    }
    y
  }
  
  max_y_idx <- localMaxima(y)
  
  max_y <- y.sg4[max_y_idx]
  
  find_peaks_dat <- df_smooth[df_smooth$y.sg4 %in% c(max_y),]
  
  x_find_peaks <- find_peaks_dat$x
  
  y_find_peaks <- find_peaks_dat$y.sg4
  
  data.plot <- ggplot(find_peaks_dat, aes(x_find_peaks, y_find_peaks)) +geom_line() + labs(x="m/z",fill="intensity")
  
  data.plot.value <- ggplot_build(data.plot)
  
  peaks <- ggplot_build(data.plot+stat_peaks(span =10, data=data.plot.value[['data']][[1]], aes(x=x_find_peaks,y=y_find_peaks), geom="point", col="red"))
  
  peak_x <- peaks$plot$plot_env$peaks$data[[2]]$xintercept
  
  peak_y <- peaks$plot$plot_env$peaks$data[[2]]$yintercept
  
  peak_df <- data.frame(peak_x, peak_y)
  
  df_filt_er <- subset(peak_df, round(peak_df$peak_x - shift(peak_df$peak_x, type='lag'), 1) >= charge_shift)
  
  x_filt <- df_filt_er$peak_x
  
  y_filt <- df_filt_er$peak_y
  
  df_filt <- data.frame(x_filt, y_filt)
  
  plot1 <- ggplot(df_filt, aes(x_filt,y_filt)) + geom_point() + labs(x="m/z",fill="intensity")
  
  plotdat <- ggplot_build(plot1)
  
  mean_idx <- which.min(abs(mean(x_filt)-df_filt$x_filt))
  
  outlier_filt_x <- subset(df_filt, df_filt$x_filt > df_filt$y_filt[mean_idx])
  
  min_idx <- which.min(outlier_filt_x$y_filt)
  
  idx_rmv = length(outlier_filt_x$y_filt) - min_idx
  
  outlier_filt_y <- outlier_filt_x %>% filter(row_number() >= n()-idx_rmv+1)
  
  outlier_filt_fin <- subset(outlier_filt_x, outlier_filt_x$x_filt < 10)
  
  outlier_filt_1 <- df_filt[!(df_filt$x_filt %in% outlier_filt_y$x_filt),]
  outlier_filt <- outlier_filt_1[!(outlier_filt_1$x_filt %in% outlier_filt_fin$x_filt),]
  
  mixture<-normalmixEM(outlier_filt$x_filt, sd.constr = c("a", "a"), arbmean = TRUE, arbvar = TRUE, maxit = Inf, maxrestarts = Inf)
  
  ptest <- predict(loess(outlier_filt$y_filt ~ outlier_filt$x_filt, family="gaussian", span= 0.2), outlier_filt)
  
  p_pred <- data.frame(outlier_filt$x_filt, ptest)
  
  amp1 <- approx(p_pred$outlier_filt.x_filt, p_pred$ptest, xout=mixture$mu[1])
  
  amp2 <- approx(p_pred$outlier_filt.x_filt, p_pred$ptest, xout=mixture$mu[2])
}
#> span increased to next odd value:  11 
#> number of iterations= 1
#> Error in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : span is too small
{
  x <- x_filt
  
  fit <- nls(y_filt ~ (C1*exp(-(x-mean1)**2/(2 * sigma1**2)) +
                         C2*exp(-(x-mean2)**2/(2 * sigma2**2))),
             data = df_filt,
             start = list(mean1 = mixture$mu[1],
                          mean2 = mixture$mu[2],
                          sigma1 = mixture$sigma[1],
                          sigma2 = mixture$sigma[2],
                          C1 = amp1$y,
                          C2 = amp2$y),
             lower =c(0,0,mixture$sigma[1],mixture$sigma[2],0,0),
             upper=c(Inf, Inf, mixture$sigma[1], mixture$sigma[2], 100, 100),
             algorithm = "port",
  )
  
  dffit <- data.frame(x=x_filt)
  dffit$y <- predict(fit, newdata=dffit)
  fit.sum <- summary(fit)
  fit.sum
  
  coef.fit <- fit.sum$coefficients[,1]
  mu.fit <- coef.fit[1:2]
  sigma.fit <- coef.fit[3:4]
  c.fit <- coef.fit[5:6]
}
#> Error in nls(y_filt ~ (C1 * exp(-(x - mean1)^2/(2 * sigma1^2)) + C2 * : object 'amp1' not found
{
  plot_x <- append(outlier_filt$x_filt, peak_x[1], 0)
  plot_y <- append(outlier_filt$y_filt, peak_y[1], 0)
  plot_df <- data.frame(plot_x, plot_y)
  
  #original
  plot(df_smooth$y.sg4 ~ df_smooth$x, data = df_smooth, type = "l", main = "10 sec", xlab="m/z", lwd=1.5, ylab="Intensity", font=2) 
  box(lwd=2)
  #overall fit
  lines(plot_y ~ plot_x, data = plot_df, col ="red", cex = 0.2, lwd=2.5) 
  #components of the fit
  for(i in 1:2){
    x <- dffit$x
    y <- c.fit[i] *exp(-(x-mu.fit[i])**2/(2 * sigma.fit[i]**2))
    lines(x,y, col = i + 2, lwd=2.5)
  }
  FWHM_1 = 2*sqrt(log(2)*2)*sigma.fit[1]
  FWHM_2 = 2*sqrt(log(2)*2)*sigma.fit[2]
  setequal(FWHM_1,FWHM_2)
  FWHM <- FWHM_1
  
  y_AUC_1 <- c.fit[1] *exp(-(x-mu.fit[1])**2/(2 * sigma.fit[1]**2))
  id <- order(dffit$x)
  AUC_1 <- sum(diff(dffit$x[id])*rollmean(y_AUC_1[id],2))
  AUC_1
  y_AUC_2 <- c.fit[2] *exp(-(x-mu.fit[2])**2/(2 * sigma.fit[2]**2))
  AUC_2 <- sum(diff(dffit$x[id])*rollmean(y_AUC_2[id],2))
  AUC_2
  AUC_Sum = AUC_1 + AUC_2
  AUC_tot <- c(AUC_Sum, NA)
  AUC_list <- c(AUC_1, AUC_2)
  centroid_idx <- which.max((peak_x*peak_y)/length(peak_x))
  centroid <- peak_x[centroid_idx]
  
  output_10sec <- data.frame(mu.fit, centroid, c.fit, sigma.fit, FWHM, AUC_list, AUC_tot)
  colnames(output_10sec) <- c('Mean Value','Centroid','Height','SD','FWHM', 'Area', 'Area Total')
  rownames(output_10sec) <- c("Peak 1, 10 sec", "Peak 2, 10 sec")
  print(output_10sec)
}
#> Error in eval(expr, envir, enclos): object 'dffit' not found


Created on 2022-07-04 by the reprex package (v2.0.1)
